---
layout: post
title: 技术债治理的三条原则
---

”技术债“是Ward Cunningham在1992年提出的，它主要被用来描述理想中的解决方案和当前解决方案中间的差距所隐含的潜在成本。这种隐喻和金融债务非常类似，这也是这个隐喻的高明之处：为了解决短期的资金压力，获得短期收益，个人或企业向银行或他人借款，从而产生债务，这种债务需要付出的额外的代价是利息，如果短期商业的投资所带来的收益大于利息，这也许是一种明智的做法，但如果入不敷出，收益不及债务产生的利息导致资产受损，虽然长期来看这种投资仍然有可能扭亏转盈，但是整个过程风险很大，可能随时会导致个人或企业破产。

如果把技术债也看做一种投资，获得的短期收益可能是快速上线、所带来的商业利益，比如新的功能吸引了更多的付费用户，解决了短期之内的资金缺口问题；赶在竞争对手之前上线了杀手级应用，并快速地抢占了市场。所以技术债的存在有很多积极意义，但是我们会经常过度关注这些积极的因素，而忽略了技术债长期存在所导致的“利息”。

## 技术债全景图

卡内基-梅龙大学软件工程研究所（SEI）的Robert Nord在[《The Future of Managing Technical Debt》](https://insights.sei.cmu.edu/sei_blog/2016/08/the-future-of-managing-technical-debt.html)提出了“技术债务全景图”（Tech Debt Landscape）的概念，我们可以借助于这个模型定性或者定量分析技术债务所产生的“利息”：
![技术全景图](/assets/images/tech-debt-landscape.png)

这张全景图从三个维度来分析技术债对于软件的影响：可演进性（Evolvability）、可维护性（Maintainability）、可见度（Visibility）。

其中可演进性（Evolvability）指的是系统适应变化的能力。 在生物学中它指的是种群产生适应性的遗传多样性，从而通过自然选择进化的能力。对软件系统来说，可演进性（Evolvability）本质上一种架构的元特征（Meta-Characteristic），描述的是软件架构趋于目标演进的能力，演进目标并不仅局限于支撑功能快速迭代的灵活性（Flexibility），也可以是其他的架构属性（Quality Attribute），比如高可用性、可扩展性。

## 技术债治理的困境

技术全景图的分类方法可以帮助我们更全面地了解技术债导致的问题，在可演进性和可维护性这两个维度，我们都可以提取出一些指标来量化“利息”，但是这些指标和业务功能相比终究显得太过苍白无力，并不足以说服主要的业务端干系人并获得对于技术改进的支持。

很多技术管理者或多或少地都会遇到这样的困境：面对技术债心有余而力不足，自己的意见总是被忽视，积压的技术问题迟迟得不到解决。我想信很多团队在治理技术债时都遇到过和同样的阻力。Mike Cohn（《Scrum敏捷软件开发》作者）曾经使用下面这张图描述大多数项目遇到的类似情况：在第一个迭代需要花费大量的时间和精力来进行架构的设计，在后续的迭代中对于架构方面的投资不断降低，期望可以一直延续之前的架构设计并从中持续受益。
![Tech Effort Percentage](/assets/images/tech-effort-percentage.png)

我们也曾经在团队中大刀阔斧地尝试了技术债治理的变革，团队进行头脑风暴（Brainstorm）收集技术债问题，添加到敏捷项目管理工具中统一管理，然后对于这些技术问题进行全局的优先级排序。在业务端也积极地进行了技术债相关理论知识的导入，陈述技术债的产生原因和危害。业务端负责人非常认同技术债治理的意义甚至主动提出要把技术债放到每个迭代（Iteration）中治理、追踪，但是当下个迭代开始时能够排到迭代（Iteration）计划中的仍然少之又少。

我们反思这次尝试失败的原因，其一在于技术债所导致的“利息”是间接和难以衡量的，这种潜在的长期危害和短期的收益冲突时，人们更倾向于选择短期收益。另外对于技术债的选择缺少战略层面的思考，并没有识别出和业务演进方向更加匹配的高价值问题。我们基于项目中技术债治理的实践经验，总结出了技术债治理的三条原则，也许可以为缓解这种困境提供一些不同的视角和思路。

## 技术债治理的三条原则

### 1. 核心领域优先

识别领域、子域是DDD战略设计的重要步骤，在识别子域之后我们还需要进一步分析哪些是核心域（Core Domain），哪些是支撑子域（Supporting SubDomain）和通用子域（Generic Subdomain）。核心域在业务上至关重要，它提供了区别于行业竞争对手的差异化优势，承载的业务背后的最核心的基础理念。《领域驱动设计》的作者、DDD概念的提出者 Eric Evans 是这样描述核心域的：

> The Core Domain should deliver about 20% of the total value of the entire system, be about 5% of the code base, and take about 80% of the effort.

我们可以借助于这种战略建模方式，根据解决技术债之后所产生的收益，将其放置于领域图中的不同位置，可以得到类似这样的可视化结果。在建立关联之后，需要遵循”核心域优先、支撑子域次之“的原则来选择技术债。也许我们可以把这种评估技术债优先级的方式叫做“Tech Debt Mapping”。

![Tech Debt Mapping](/assets/images/tech-debt-mapping-1.png)

### 2. 可演进性优于可维护性

技术债导致的不可见的Evolvability问题大多和架构相关，比如服务和服务之间的循环依赖、模块和模块之间的过度耦合、缺少模块化和服务边界的“大泥球”组件等，在添加新的功能时，这些架构的坏味道会给产品功能的迭代造成不少的麻烦。比如服务之间如果存在循环依赖的问题，当你对系统进行少量更改时，它可能会对其他模块产生连锁反应，这些模块可能会产生意想不到的错误或者异常。此外，如果两个模块过度耦合、相互依赖，则单个模块的重用也变得极其困难。

可见的Evolvability问题包括开发速度滞后、功能无法按期交付、系统吞吐量遇到瓶颈难以提升等，这些问题虽然容易察觉，但是问题发生的时候往往“积重难返”。引入的技术债务没有在合适的时间得到解决，其产生的影响会像“滚雪球”一样越滚越大。在我所经历过的项目中有一个不太合理的模型设计，由于错过了最佳的纠正时间，随着业务变化最终不得不做服务拆分时，发现需要修改的调用点竟有近1000多处，而且这些修改点很难借助于IDE或者重构工具来一次性解决，不但增加了团队的负担还直接导致了功能的延期交付。

对于高复杂度、霰弹式修改等不可见的可维护性问题，可以借助比较成熟的静态代码扫描工具来自动识别，比如[SonarQube](https://www.sonarqube.org/)、[checkstyle](https://github.com/checkstyle/checkstyle) 等，但是仅仅在持续集成上（Continuous Integration）运行还不够，需要和团队一起自定义扫描规则，并把检查代码扫描报告作为代码审查（Code Review）的一部分，逐步形成一种正向的反馈机制。

所以我们在治理技术债的第二个原则是 “可演进性优于可维护性”。如果把上文提到的可维护性和可演进性使用不同的颜色来标识的话，我们可以得到这样的结果：
![Tech Debt Mapping](/assets/images/tech-debt-mapping-2.png)

### 3. 警惕“沉没成本谬误”

关于“沉没成本谬误”的概念在《薛兆丰经济学课》中有一个非常通俗的解释：

> 我们在看电影的时候，坐在电影院里面15~20分钟，就知道这部电影好不好看。但是电影票已经买了，钱已经付了，如果这部电影不好看的话，你最合适的做法是及时止损，当场离开，已经损失了买电影票的钱，不要再继续损失自己宝贵的时间。但是电影院里面要播一部烂片，有多少人会在电影播到10分钟20分钟的时候，就当机立断地站起来离开呢？

在看到这个概念时立刻想到了一个项目中和技术选型相关的例子：

在三年前我们做了一次错误的技术选型，引入了一个非常不成熟的数据库，在没有充分隔离的情况下在架构中大规模使用，之后接连遇到了数据文件损坏、事务写入超时、集群突然宕机等诡异的问题。之后这种问题便持续不断。

团队围绕该数据库构建了服务健康状况监控工具、数据修复工具、提高易用性的客户端库等，在架构中也引入消息机制避免数据丢失。同时团队也持续进行了很多知识积累，内部还有专门的兴趣小组，从中产生了几位熟悉该数据库的专家，甚至有的人还为它贡献了源码。客户也不断升级了数据库服务器硬件并购买了商用的授权，之后虽然大问题不多，但是小问题仍然源源不断，那些无法解释的诡异问题仍然存在。

当三年后当我们再次重新回顾这个技术决策时发现其所代表的架构风格并不适合我们项目，一开始宏伟的设想并不现实，它带来的问题比解决的问题更多。那更合适的选择是什么？要推到重来吗？想到我们在过去三年数不清的问题讨论和技术改进，一次次的产品环境支持和数据库升级，是否会有一丝犹豫？

假如我们当时没有做这个选择，那这些时间和精力应该花在什么地方才能凸显其高于现在的价值？

在技术债治理的过程中，实践可以剪裁，甚至原则也可以妥协，但我们需要保持的是这样的思考：技术改进对于个人、团队、公司和客户的价值是什么？

## 引用

1. [The Future of Managing Technical Debt](https://insights.sei.cmu.edu/sei_blog/2016/08/the-future-of-managing-technical-debt.html)
2. [Managing Technical Debt](https://www.infoq.com/articles/managing-technical-debt)
3. [DDD: Strategic Design: Core, Supporting, and Generic Subdomains](http://blog.jonathanoliver.com/ddd-strategic-design-core-supporting-and-generic-subdomains/)
4. [Managing Software Debt: Building for Inevitable Change](https://www.amazon.com/Managing-Software-Debt-Inevitable-Development/dp/0321948610) 
5. [We’re Drowning in Tech Debt. Why Isn’t Anyone Listening?](https://hackernoon.com/were-drowning-in-tech-debt-why-isn-t-anyone-listening-f4269cb5cc40)
